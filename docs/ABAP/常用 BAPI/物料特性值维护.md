## 物料特性值维护

在销售订单创建或修改时，对配置物料特性值维护

```ABAP
DATA: LT_RETURN TYPE TABLE OF BAPIRET2,
      LV_ERRMSG TYPE STRING.
*DATA: LV_BATCH_O           TYPE BAPIBATCHKEY-BATCH,
*      LS_BATCHATTRIBUTES_O TYPE BAPIBATCHATT.
DATA: LV_MATNR              TYPE BAPIBATCHKEY-MATERIAL,
      LV_BATCH              TYPE BAPIBATCHKEY-BATCH,
      LV_PLANT              TYPE BAPIBATCHKEY-PLANT,
      LS_BATCHATTRIBUTES    TYPE BAPIBATCHATT,
      LS_BATCHCONTROLFIELDS TYPE BAPIBATCHCTRL.

LV_MATNR = '000000000000000005'.
LV_BATCH = 'Y211031002'.
LV_PLANT = '6000'.


LS_BATCHCONTROLFIELDS-DOCLASSIFY = 'X'. "打上才会有MCH1表中查询到CUOBJ_BM数据

CALL FUNCTION 'BAPI_BATCH_CREATE'
  EXPORTING
    MATERIAL           = LV_MATNR
    BATCH              = LV_BATCH
    PLANT              = LV_PLANT
    BATCHATTRIBUTES    = LS_BATCHATTRIBUTES
    BATCHCONTROLFIELDS = LS_BATCHCONTROLFIELDS
*  IMPORTING
*   BATCH              = LV_BATCH_O
*   BATCHATTRIBUTES    = LS_BATCHATTRIBUTES_O
  TABLES
    RETURN             = LT_RETURN.

PERFORM FRM_PROCESS_RETURN_MSG TABLES LT_RETURN USING LV_ERRMSG.

IF LV_ERRMSG IS INITIAL.
  CALL FUNCTION 'BAPI_TRANSACTION_COMMIT'
    EXPORTING
      WAIT = 'X'.

  "-----------------------------------------------------------------------
  DATA: OBJECTKEYTABLE TYPE TABLE OF BAPI1003_OBJECT_KEYS WITH HEADER LINE.
  DATA: OBJECTKEY TYPE BAPI1003_KEY-OBJECT.

  OBJECTKEYTABLE-KEY_FIELD = 'MATNR'.
  OBJECTKEYTABLE-VALUE_INT = LV_MATNR.
  APPEND OBJECTKEYTABLE.

  OBJECTKEYTABLE-KEY_FIELD = 'CHARG'.
  OBJECTKEYTABLE-VALUE_INT = LV_BATCH.
  APPEND OBJECTKEYTABLE.

* Only if Batch management is Plant dependant
  OBJECTKEYTABLE-KEY_FIELD = 'WERKS'.
  OBJECTKEYTABLE-VALUE_INT = LV_PLANT.
  APPEND OBJECTKEYTABLE.

  CALL FUNCTION 'BAPI_OBJCL_CONCATENATEKEY'
    EXPORTING
      OBJECTTABLE    = 'MCH1'
    IMPORTING
      OBJECTKEY_CONC = OBJECTKEY
*     OBJECTKEY_CONC_LONG       =
    TABLES
      OBJECTKEYTABLE = OBJECTKEYTABLE
      RETURN         = LT_RETURN.
  "-----------------------------------------------------------------------

  DATA: CLASSNUM  TYPE BAPI1003_KEY-CLASSNUM,
        CLASSTYPE TYPE BAPI1003_KEY-CLASSTYPE.
  DATA: ALLOCVALUESNUMNEW  TYPE TABLE OF BAPI1003_ALLOC_VALUES_NUM WITH HEADER LINE,
        ALLOCVALUESCHARNEW TYPE TABLE OF BAPI1003_ALLOC_VALUES_CHAR WITH HEADER LINE,
        ALLOCVALUESCURRNEW TYPE TABLE OF BAPI1003_ALLOC_VALUES_CURR WITH HEADER LINE.

  CLASSNUM = 'Z_BATCH_RAW'.
  CLASSTYPE = '023'.  "023 = 批次

  ALLOCVALUESCHARNEW-CHARACT = 'Z_MNFR'.
  ALLOCVALUESCHARNEW-VALUE_CHAR = 'TEST111'.
  APPEND ALLOCVALUESCHARNEW.

  CALL FUNCTION 'BAPI_OBJCL_CHANGE'
    EXPORTING
      OBJECTKEY          = OBJECTKEY
      OBJECTTABLE        = 'MCH1'  "这个要和上面的保持一致 " MCH1 in case of cross-plant batch management
      CLASSNUM           = CLASSNUM
      CLASSTYPE          = CLASSTYPE
*     STATUS             = '1'
*     STANDARDCLASS      =
*     CHANGENUMBER       =
*     KEYDATE            = SY-DATUM
*     NO_DEFAULT_VALUES  = ' '
*     KEEP_SAME_DEFAULTS = ' '
*     OBJECTKEY_LONG     =
* IMPORTING
*     CLASSIF_STATUS     =
    TABLES
      ALLOCVALUESNUMNEW  = ALLOCVALUESNUMNEW
      ALLOCVALUESCHARNEW = ALLOCVALUESCHARNEW
      ALLOCVALUESCURRNEW = ALLOCVALUESCURRNEW
      RETURN             = LT_RETURN.

  PERFORM FRM_PROCESS_RETURN_MSG TABLES LT_RETURN USING LV_ERRMSG.

  IF LV_ERRMSG IS INITIAL.
    CALL FUNCTION 'BAPI_TRANSACTION_COMMIT'
      EXPORTING
        WAIT = 'X'.
  ELSE.
    CALL FUNCTION 'BAPI_TRANSACTION_ROLLBACK'.
  ENDIF.

ELSE.
  CALL FUNCTION 'BAPI_TRANSACTION_ROLLBACK'.
ENDIF.

BREAK-POINT.

*&---------------------------------------------------------------------*
*& Form FRM_PROCESS_RETURN_MSG
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*&      --> LT_RETURN
*&      <-- LV_ERRMSG
*&---------------------------------------------------------------------*
FORM FRM_PROCESS_RETURN_MSG TABLES   PT_RETURN STRUCTURE BAPIRET2
                            CHANGING PV_ERRMSG TYPE STRING.
  DATA: LV_ITEMMSG TYPE STRING.

  CLEAR PV_ERRMSG.

  LOOP AT PT_RETURN INTO DATA(PS_RETURN) WHERE TYPE = 'E' OR TYPE = 'A' OR TYPE = 'X'.
    CLEAR LV_ITEMMSG.
    CALL FUNCTION 'MESSAGE_TEXT_BUILD'
      EXPORTING
        MSGID               = PS_RETURN-ID
        MSGNR               = PS_RETURN-NUMBER
        MSGV1               = PS_RETURN-MESSAGE_V1
        MSGV2               = PS_RETURN-MESSAGE_V2
        MSGV3               = PS_RETURN-MESSAGE_V3
        MSGV4               = PS_RETURN-MESSAGE_V4
      IMPORTING
        MESSAGE_TEXT_OUTPUT = LV_ITEMMSG.
    PV_ERRMSG = |{ PV_ERRMSG }{ LV_ITEMMSG };|.
  ENDLOOP.

ENDFORM.
```

