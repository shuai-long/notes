# 权限检查 #

## 利润中心权限检查 ##

* 根据自建角色进行检查

  ```abap
  "根据用户查找角色
  SELECT
    A~UNAME,
    A~FROM_DAT,
    A~AGR_NAME
    INTO TABLE @DATA(LT_AGR_DEFINE)
    FROM AGR_USERS AS A
    INNER JOIN AGR_DEFINE AS B
    ON A~AGR_NAME EQ B~AGR_NAME
    WHERE A~UNAME EQ @SY-UNAME
    AND FROM_DAT LE @SY-DATUM
    AND PARENT_AGR EQ ' '. "业务顾问配置的角色
  
  "根据角色查找权限对象
  IF LT_AGR_DEFINE[] IS NOT INITIAL.
    SELECT *
      INTO TABLE @DATA(LT_AGR_1251)
      FROM AGR_1251
      FOR ALL ENTRIES IN @LT_AGR_DEFINE
      WHERE AGR_NAME EQ @LT_AGR_DEFINE-AGR_NAME
      AND OBJECT EQ 'K_PCA'
      AND FIELD EQ 'RESPAREA'.
  ENDIF.
  
  IF NOT LINE_EXISTS( LT_AGR_1251[ LOW = '*' ] ).
    LOOP AT LT_AGR_1251 INTO DATA(LS_AGR_1251).
      CLEAR S_PRCTR.
      S_PRCTR+0(3) = 'IBT'.
      S_PRCTR-LOW = LS_AGR_1251-LOW+6(10).
      S_PRCTR-HIGH = LS_AGR_1251-HIGH+6(10).
      APPEND S_PRCTR.
    ENDLOOP.
    IF |{ P_PRCTR ALPHA = IN }| NOT IN S_PRCTR.
      DATA(LV_MESSAGE) = '您没有' && P_PRCTR && '的权限'.
      MESSAGE: LV_MESSAGE TYPE 'E'.
    ENDIF.
  ENDIF.
  ```

* 根据 `$PRCTR` 检查利润中心

  ```abap
  TABLES: ACDOCA.
  SELECT-OPTIONS S_PRCTR FOR ACDOCA-PRCTR.
  
  RANGES:R_PRCTR FOR ACDOCA-PRCTR.
  DATA(LV_MESSAGE) = '未找到权限配置' .
  
  SELECT
    UNAME,
    FROM_DAT,
    TO_DAT,
    VARBL,
    LOW,
    HIGH
    INTO TABLE @DATA(LT_AGR_1252)
    FROM AGR_USERS
    INNER JOIN AGR_1252
    ON AGR_USERS~AGR_NAME EQ AGR_1252~AGR_NAME
    AND UNAME EQ @SY-UNAME
    AND FROM_DAT LE @SY-DATUM
    AND TO_DAT GE @SY-DATUM
    AND VARBL = '$PRCTR'.
  
  IF LINE_EXISTS( LT_AGR_1252[ LOW = ''  HIGH = '' ] ) .
    MESSAGE: LV_MESSAGE TYPE 'S' DISPLAY LIKE 'E'.
    LEAVE LIST-PROCESSING.
    STOP.
  ENDIF.
  
  
  LOOP AT LT_AGR_1252 INTO DATA(LS_AGR_1252) WHERE LOW NE '*' .
  
    IF LS_AGR_1252-LOW IS NOT INITIAL AND LS_AGR_1252-HIGH IS INITIAL.
      R_PRCTR+0(3) = 'IEQ'.
      R_PRCTR-LOW = LS_AGR_1252-LOW.
      APPEND R_PRCTR.
      CLEAR R_PRCTR.
    ENDIF.
  
    IF LS_AGR_1252-LOW IS NOT INITIAL AND LS_AGR_1252-HIGH IS NOT INITIAL.
      R_PRCTR+0(3) = 'IBT'.
      R_PRCTR-LOW = LS_AGR_1252-LOW.
      R_PRCTR-HIGH = LS_AGR_1252-HIGH.
      APPEND R_PRCTR.
      CLEAR R_PRCTR.
    ENDIF.
  
    IF LS_AGR_1252-LOW IS INITIAL AND LS_AGR_1252-HIGH IS NOT INITIAL.
      R_PRCTR+0(3) = 'IEQ'.
      R_PRCTR-LOW = LS_AGR_1252-HIGH.
      APPEND R_PRCTR.
      CLEAR R_PRCTR.
    ENDIF.
  ENDLOOP.
  
  DATA(LT_PRCTR) = S_PRCTR[].
  SELECT * INTO TABLE @DATA(LT_CEPC) FROM CEPC WHERE KOKRS EQ 'CCTC' AND PRCTR IN @S_PRCTR[].
  
  READ TABLE LT_AGR_1252 INTO LS_AGR_1252 WITH KEY LOW = '*'.
  IF SY-SUBRC NE 0.
    REFRESH S_PRCTR[].
    LOOP AT LT_CEPC INTO DATA(LS_CEPC).
      IF LS_CEPC-PRCTR IN R_PRCTR AND LS_CEPC-PRCTR IN LT_PRCTR[].
        CLEAR S_PRCTR.
        S_PRCTR-SIGN = 'I'.
        S_PRCTR-OPTION = 'EQ'.
        S_PRCTR-LOW = LS_CEPC-PRCTR.
        APPEND S_PRCTR.
      ENDIF.
    ENDLOOP.
  ENDIF.
  ```

## 工资范围权限检查 ##

```abap
   AUTHORITY-CHECK OBJECT 'P_PCR' ID 'ABRKS' FIELD t_tab-abkrs.
```

## 结构化组织权限 ##

